<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <title>EazyPay Kassa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body { font-family: Arial; background:#111; color:#fff; padding:30px }
    .card { max-width:520px; margin:auto; background:#1b1b1b; padding:20px; border-radius:12px }
    input, button { width:100%; padding:12px; margin-top:10px }
    button { background:#2d6cdf; color:#fff; border:0; border-radius:8px }
    #qrcode { background:#fff; padding:12px; display:inline-block }
    .center { text-align:center }
  </style>
</head>

<body>
<div class="card" id="kassa">
  <h2>EazyPay Kassa</h2>

  <input id="amount" value="1.00" placeholder="Bedrag">
  <input id="reference" placeholder="Omschrijving (optioneel)">
  <button onclick="startPayment()">Toon QR</button>

  <div class="center" id="qrWrap" style="display:none">
    <div id="qrcode"></div>
    <p>Scan om te betalen</p>
  </div>
</div>

<script>
let transactionId = null;
let pollTimer = null;

async function startPayment() {
  document.getElementById("qrcode").innerHTML = "";
  document.getElementById("qrWrap").style.display = "none";

  const amount = document.getElementById("amount").value;
  const reference = document.getElementById("reference").value;

  const res = await fetch("/.netlify/functions/create-paylink", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount, reference })
  });

  const data = await res.json();
  transactionId = data.transactionId;

  new QRCode(document.getElementById("qrcode"), {
    text: data.paymentUrl,
    width: 260,
    height: 260
  });

  document.getElementById("qrWrap").style.display = "block";
  startPolling();
}

function startPolling() {
  pollTimer = setInterval(async () => {
    const res = await fetch("/.netlify/functions/status?id=" + transactionId);
    const data = await res.json();

    if (data.status === "PAID") {
      clearInterval(pollTimer);
      window.location.href = "/kassa-betaald.html";
    }
  }, 3000);
}
</script>
</body>
</html>
