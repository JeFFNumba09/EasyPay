<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EazyPay Kassa</title>

   <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:24px; }
    .card { max-width:520px; margin:0 auto; background:#fff; border:1px solid #ddd; border-radius:12px; padding:20px; }
    label { display:block; margin:12px 0 6px; }
    input { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; }
    button { width:100%; padding:12px; border:0; border-radius:10px; background:#111; color:#fff; cursor:pointer; margin-top:14px; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { margin-top:14px; }
    #qr { display:flex; justify-content:center; margin-top:16px; }
    .muted { color:#666; font-size:14px; margin-top:8px; }
    .amountline { margin-top:10px; font-weight:bold; }
  </style>
</head>

<body>
  <div class="card">
    <h2>EazyPay Kassa</h2>

    <label>Bedrag in euro (bijv. 1.00)</label>
    <input id="amount" value="1.00" inputmode="decimal" />

    <label>Omschrijving / referentie (optioneel)</label>
    <input id="desc" value="test" />

    <button id="btn">Toon QR</button>

    <div class="amountline" id="amountline">Te betalen: €1.00</div>
    <div class="muted" id="status"></div>

    <div id="qr"></div>
  </div>

  <script>
    const btn = document.getElementById("btn");
    const amountEl = document.getElementById("amount");
    const descEl = document.getElementById("desc");
    const qrEl = document.getElementById("qr");
    const statusEl = document.getElementById("status");
    const amountLineEl = document.getElementById("amountline");

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function eurosToNumber(str) {
      // accepteert "1,00" en "1.00"
      const normalized = String(str).replace(",", ".").trim();
      const n = Number(normalized);
      return n;
    }

    amountEl.addEventListener("input", () => {
      const eur = eurosToNumber(amountEl.value);
      if (Number.isFinite(eur)) {
        amountLineEl.textContent = `Te betalen: €${eur.toFixed(2)}`;
      }
    });

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      qrEl.innerHTML = "";
      setStatus("");

      try {
        const eur = eurosToNumber(amountEl.value);
        if (!Number.isFinite(eur) || eur <= 0) {
          alert("Vul een geldig bedrag in.");
          return;
        }

        const payload = {
          amountEUR: eur,                  // server zet om naar centen
          description: descEl.value || "",
          reference: descEl.value || "",
        };

        const res = await fetch("/.netlify/functions/create-paylink", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          alert("Fout bij aanmaken betaling:\n\n" + JSON.stringify(data, null, 2));
          return;
        }

        const { checkoutUrl, orderId } = data;

        setStatus("Paylink aangemaakt. QR wordt geladen.");

        // QR code van checkoutUrl genereren
       // QR server-side ophalen als PNG
qrEl.innerHTML = ""; // leegmaken
const img = document.createElement("img");
img.alt = "QR";
img.style.width = "260px";
img.style.height = "260px";
img.src = `/.netlify/functions/qr?text=${encodeURIComponent(checkoutUrl)}`;
qrEl.appendChild(img);


        qrEl.innerHTML = "";
const img = document.createElement("img");
img.alt = "QR";
img.style.width = "260px";
img.style.height = "260px";
img.src = `/.netlify/functions/qr?text=${encodeURIComponent(checkoutUrl)}`;
qrEl.appendChild(img);


        setStatus(`Order ID: ${orderId}`);
      } catch (e) {
        alert("Fout bij aanmaken betaling:\n\n" + String(e));
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>



