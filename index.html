<!-- QRCode library -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
  // Basis URL van je Netlify site
  const baseUrl = "https://profound-bunny-c7b7b3.netlify.app";

  let currentReference = null;
  let pollTimer = null;

  // Klik op "Toon QR"
  document.getElementById("toonQR").addEventListener("click", async function () {
    const bedragInput = document.getElementById("bedrag");
    const bedrag = Number(bedragInput.value);

    if (!bedrag || bedrag <= 0) {
      alert("Vul een geldig bedrag in");
      return;
    }

    // Tekst tonen
    document.getElementById("bedragTekst").innerText =
      "Te betalen: â‚¬" + bedrag.toFixed(2);

    // Pay.nl paylink aanvragen via Netlify function
    const resp = await fetch(`${baseUrl}/.netlify/functions/create-paylink`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ amount: bedrag })
    });

    const data = await resp.json();

    if (!resp.ok || !data.checkoutUrl || !data.reference) {
      alert("Fout bij aanmaken Pay.nl betaling");
      console.error(data);
      return;
    }

    currentReference = data.reference;

    // QR leegmaken en opnieuw tekenen
    const qrDiv = document.getElementById("qrcode");
    qrDiv.innerHTML = "";

    new QRCode(qrDiv, {
      text: data.checkoutUrl,
      width: 220,
      height: 220,
      correctLevel: QRCode.CorrectLevel.H
    });

    // Start status polling
    startPolling();
  });

  function startPolling() {
    if (pollTimer) {
      clearInterval(pollTimer);
    }

    pollTimer = setInterval(async () => {
      if (!currentReference) return;

      const resp = await fetch(
        `${baseUrl}/.netlify/functions/status?reference=${encodeURIComponent(currentReference)}`
      );
      const data = await resp.json();

      if (data.status === "PAID") {
        document.getElementById("bedragTekst").innerText = "Betaald";
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }, 2000);
  }
</script>
