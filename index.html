<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EazyPay Kassa</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff; margin:0; }
    .wrap { max-width: 520px; margin: 60px auto; padding: 0 16px; text-align:center; }
    h1 { font-size: 34px; margin: 0 0 26px; font-weight: 700; }
    input, button { width: 100%; max-width: 420px; box-sizing: border-box; }
    input { padding: 14px 12px; font-size: 16px; margin: 10px 0; }
    button { padding: 14px 12px; font-size: 16px; margin: 10px 0; cursor:pointer; }
    #bedragTekst { font-size: 20px; margin: 18px 0 14px; font-weight: 700; }
    #statusTekst { font-size: 16px; margin: 10px 0 0; }
    #qrcode { display:flex; justify-content:center; margin-top: 18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>EazyPay Kassa</h1>

    <input id="bedrag" type="number" step="0.01" placeholder="Bedrag in EUR" />
    <input id="memo" type="text" placeholder="Omschrijving, naam of factuurnummer (optioneel)" />

    <button id="toonQR">Toon QR</button>

    <div id="bedragTekst"></div>
    <div id="qrcode"></div>
    <div id="statusTekst"></div>
  </div>

  <!-- QRCode library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <script>
    let currentOrderId = null;
    let pollTimer = null;

    document.getElementById("toonQR").addEventListener("click", async () => {
      try {
        const bedrag = Number(document.getElementById("bedrag").value);
        const memo = String(document.getElementById("memo").value || "").trim();

        if (!bedrag || bedrag <= 0) {
          alert("Vul een geldig bedrag in");
          return;
        }

        document.getElementById("bedragTekst").innerText = "Te betalen: â‚¬" + bedrag.toFixed(2);
        document.getElementById("statusTekst").innerText = "";
        document.getElementById("qrcode").innerHTML = "";

        // Zelfde origin gebruiken, geen baseUrl nodig
        const resp = await fetch("/.netlify/functions/create-paylink", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount: bedrag, memo })
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok || !data.checkoutUrl || !data.orderId) {
          alert("Fout bij aanmaken betaling:\n\n" + JSON.stringify(data, null, 2));
          return;
        }

        currentOrderId = data.orderId;

        new QRCode(document.getElementById("qrcode"), {
          text: data.checkoutUrl,
          width: 220,
          height: 220,
          correctLevel: QRCode.CorrectLevel.H
        });

        document.getElementById("statusTekst").innerText = "Wachten op betaling...";
        startPolling();
      } catch (e) {
        alert("Onverwachte fout:\n\n" + (e?.message || e));
      }
    });

    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        if (!currentOrderId) return;

        const resp = await fetch("/.netlify/functions/status?orderId=" + encodeURIComponent(currentOrderId));
        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          document.getElementById("statusTekst").innerText = "Status fout: " + (data.error || "onbekend");
          return;
        }

        if (data.status === "PAID") {
          document.getElementById("statusTekst").innerText = "Betaald";
          clearInterval(pollTimer);
          pollTimer = null;
        } else if (data.status && data.status !== "UNKNOWN") {
          document.getElementById("statusTekst").innerText = "Status: " + data.status;
        }
      }, 2000);
    }
  </script>
</body>
</html>
