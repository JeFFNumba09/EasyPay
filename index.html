<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EazyPay Kassa</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 60px; }
    input, button { width: 420px; max-width: 90%; padding: 14px; font-size: 18px; margin: 8px 0; }
    #qrcode { margin-top: 18px; display: inline-block; }
    #debugBox { width: 520px; max-width: 92%; margin: 18px auto; text-align: left; font-size: 12px; padding: 10px; background: #f2f2f2; border-radius: 8px; white-space: pre-wrap; }
  </style>
</head>
<body>

  <h1>EazyPay Kassa</h1>

  <input id="bedrag" type="number" step="0.01" placeholder="Bedrag in euro, bv 11.00" />
  <input id="ref" type="text" placeholder="Referentie / factuurnummer / naam (optioneel)" />
  <input id="omschrijving" type="text" placeholder="Omschrijving (optioneel)" />

  <button id="toonQR">Toon QR</button>

  <div id="bedragTekst" style="margin-top: 10px; font-size: 18px;"></div>
  <div id="qrcode"></div>

  <div id="debugBox">Debug:\n-</div>

  <!-- QRCode library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <script>
    const baseUrl = "https://profound-bunny-c7b7b3.netlify.app";

    let currentReference = null;
    let pollTimer = null;

    const debugBox = document.getElementById("debugBox");
    const setDebug = (msg) => { debugBox.textContent = "Debug:\n" + msg; };

    document.getElementById("toonQR").addEventListener("click", async () => {
      try {
        const bedrag = Number(document.getElementById("bedrag").value);
        const ref = document.getElementById("ref").value.trim();
        const omschrijving = document.getElementById("omschrijving").value.trim();

        if (!bedrag || bedrag <= 0) {
          alert("Vul een geldig bedrag in");
          return;
        }

        document.getElementById("bedragTekst").innerText = "Te betalen: â‚¬" + bedrag.toFixed(2);
        setDebug("Aanvraag betaling...");

        const resp = await fetch(`${baseUrl}/.netlify/functions/create-paylink`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: bedrag,
            customerReference: ref,
            description: omschrijving
          })
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          alert("Fout bij aanmaken betaling:\n\n" + JSON.stringify(data, null, 2));
          setDebug("Fout response:\n" + JSON.stringify(data, null, 2));
          return;
        }

        if (!data.checkoutUrl || !data.reference) {
          alert("Pay.nl gaf geen checkoutUrl/reference terug");
          setDebug("Onverwachte response:\n" + JSON.stringify(data, null, 2));
          return;
        }

        currentReference = data.reference;

        const qrDiv = document.getElementById("qrcode");
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, {
          text: data.checkoutUrl,
          width: 220,
          height: 220,
          correctLevel: QRCode.CorrectLevel.H
        });

        setDebug(
          "QR gemaakt.\n" +
          "reference: " + currentReference + "\n" +
          "checkoutUrl: " + data.checkoutUrl + "\n" +
          "Polling status elke 2 sec..."
        );

        startPolling();
      } catch (e) {
        alert("Netwerkfout / scriptfout:\n" + (e?.message || e));
        setDebug("Exception:\n" + (e?.stack || e?.message || e));
      }
    });

    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        if (!currentReference) return;

        const resp = await fetch(`${baseUrl}/.netlify/functions/status?reference=${encodeURIComponent(currentReference)}`);
        const data = await resp.json().catch(() => ({}));

        // status.js geeft nu UNKNOWN, totdat we exchange.js echt status laat opslaan/teruggeven
        if (data.status === "PAID") {
          document.getElementById("bedragTekst").innerText = "Betaald";
          setDebug("Betaald!\nreference: " + currentReference);
          clearInterval(pollTimer);
          pollTimer = null;
        }
      }, 2000);
    }
  </script>
</body>
</html>
