<script>
  const amountEl = document.getElementById("amount");
  const refEl = document.getElementById("reference");
  const btn = document.getElementById("btn");
  const payText = document.getElementById("payText");
  const qrWrap = document.getElementById("qrWrap");
  const errWrap = document.getElementById("errWrap");
  const errBox = document.getElementById("errBox");
  const qrEl = document.getElementById("qrcode");

  function setError(msg) {
    errWrap.style.display = "block";
    errBox.textContent = msg;
  }

  function clearError() {
    errWrap.style.display = "none";
    errBox.textContent = "";
  }

  function updatePayText() {
    const val = String(amountEl.value || "").trim();
    payText.textContent = "Te betalen: â‚¬" + (val || "0.00");
  }

  amountEl.addEventListener("input", updatePayText);
  updatePayText();

  async function createPayment() {
    clearError();
    qrWrap.style.display = "none";
    qrEl.innerHTML = "";

    const amount = String(amountEl.value || "").trim();
    const reference = String(refEl.value || "").trim();

    btn.disabled = true;
    btn.textContent = "Bezig...";

    try {
      const resp = await fetch("/.netlify/functions/create-paylink", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, reference })
      });

      const rawText = await resp.text();
      let json;
      try { json = JSON.parse(rawText); } catch { json = { raw: rawText }; }

      if (!resp.ok) {
        setError("Fout bij aanmaken betaling:\n\n" + JSON.stringify(json, null, 2));
        return;
      }

      const paymentUrl = json.paymentUrl;
      if (!paymentUrl) {
        setError("Geen geldige paymentUrl ontvangen:\n\n" + JSON.stringify(json, null, 2));
        return;
      }

      if (typeof QRCode === "undefined") {
        setError("QRCode library niet geladen.");
        return;
      }

      new QRCode(qrEl, { text: paymentUrl, width: 260, height: 260 });
      qrWrap.style.display = "block";
    } catch (e) {
      setError("Fout bij aanmaken betaling:\n\n" + (e?.message || String(e)));
    } finally {
      btn.disabled = false;
      btn.textContent = "Toon QR";
    }
  }

  btn.addEventListener("click", createPayment);
</script>
